<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scientific Research Platform</title>
    <style>
        /* Keep all the previous CSS styles here - I'm just showing the new parts */
        
        /* Add this for cookie preferences modal */
        .cookie-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
        }
        
        .cookie-modal-content {
            background: white;
            margin: 10% auto;
            padding: 30px;
            width: 80%;
            max-width: 600px;
            border-radius: 10px;
            position: relative;
        }
        
        .cookie-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: #ccc;
            border-radius: 24px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .toggle-switch.active {
            background: #3498db;
        }
        
        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }
        
        .toggle-switch.active .toggle-slider {
            transform: translateX(26px);
        }
    </style>
</head>
<body>
    <!-- Previous HTML content stays the same until the cookie banner -->

    <!-- Cookie Banner -->
    <div class="cookie-banner" id="cookieBanner">
        <div class="cookie-text">
            <strong>We use cookies</strong><br>
            Our website uses cookies that are essential for its operation and additional cookies to track performance, analytics, and personalization. To manage your preferences, click Cookie Settings.
        </div>
        <div class="cookie-buttons">
            <button class="cookie-btn secondary" onclick="showCookieModal()">Cookie Settings</button>
            <button class="cookie-btn secondary" onclick="rejectCookies()">Reject non-essential cookies</button>
            <button class="cookie-btn primary" onclick="acceptAllCookies()">Accept all cookies</button>
        </div>
    </div>

    <!-- Cookie Preferences Modal -->
    <div class="cookie-modal" id="cookieModal">
        <div class="cookie-modal-content">
            <h2>Cookie Preferences</h2>
            <p>We use different types of cookies to enhance your experience on our website.</p>
            
            <div class="cookie-toggle">
                <div>
                    <strong>Essential Cookies</strong><br>
                    <small>Required for basic website functionality</small>
                </div>
                <div class="toggle-switch active" data-always-on="true">
                    <div class="toggle-slider"></div>
                </div>
            </div>
            
            <div class="cookie-toggle">
                <div>
                    <strong>Analytics Cookies</strong><br>
                    <small>Help us understand how visitors use our website</small>
                </div>
                <div class="toggle-switch" id="analyticsToggle" onclick="toggleCookie('analytics')">
                    <div class="toggle-slider"></div>
                </div>
            </div>
            
            <div class="cookie-toggle">
                <div>
                    <strong>Personalization Cookies</strong><br>
                    <small>Remember your preferences and settings</small>
                </div>
                <div class="toggle-switch" id="personalizationToggle" onclick="toggleCookie('personalization')">
                    <div class="toggle-slider"></div>
                </div>
            </div>
            
            <div class="cookie-toggle">
                <div>
                    <strong>Marketing Cookies</strong><br>
                    <small>Show you relevant content and advertisements</small>
                </div>
                <div class="toggle-switch" id="marketingToggle" onclick="toggleCookie('marketing')">
                    <div class="toggle-slider"></div>
                </div>
            </div>
            
            <div style="margin-top: 20px; text-align: right;">
                <button class="cookie-btn secondary" onclick="closeCookieModal()">Cancel</button>
                <button class="cookie-btn primary" onclick="saveCookiePreferences()">Save Preferences</button>
            </div>
        </div>
    </div>

    <script>
        // Cookie Management System
        class CookieManager {
            constructor() {
                this.preferences = {
                    essential: true,  // Always true
                    analytics: false,
                    personalization: false,
                    marketing: false
                };
                this.loadPreferences();
                this.initializeTracking();
            }

            // Set a cookie
            setCookie(name, value, days = 365) {
                const expires = new Date();
                expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
                document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/;SameSite=Lax`;
            }

            // Get a cookie
            getCookie(name) {
                const nameEQ = name + "=";
                const ca = document.cookie.split(';');
                for (let i = 0; i < ca.length; i++) {
                    let c = ca[i];
                    while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                    if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
                }
                return null;
            }

            // Load saved preferences
            loadPreferences() {
                const saved = this.getCookie('cookiePreferences');
                if (saved) {
                    try {
                        this.preferences = { ...this.preferences, ...JSON.parse(saved) };
                        this.preferences.essential = true; // Always keep essential as true
                    } catch (e) {
                        console.error('Error loading cookie preferences:', e);
                    }
                }
            }

            // Save preferences
            savePreferences() {
                this.setCookie('cookiePreferences', JSON.stringify(this.preferences));
                this.setCookie('cookieConsentGiven', 'true');
                this.initializeTracking();
            }

            // Initialize tracking based on preferences
            initializeTracking() {
                if (this.preferences.analytics) {
                    this.enableAnalytics();
                }
                if (this.preferences.personalization) {
                    this.enablePersonalization();
                }
                if (this.preferences.marketing) {
                    this.enableMarketing();
                }
            }

            // Analytics tracking
            enableAnalytics() {
                console.log('Analytics enabled - tracking page views, user behavior');
                
                // Example: Track page views
                this.trackPageView();
                
                // Example: Track user interactions
                document.addEventListener('click', this.trackClick.bind(this));
                
                // In a real implementation, you would integrate with:
                // Google Analytics, Adobe Analytics, etc.
                // gtag('config', 'GA_MEASUREMENT_ID');
            }

            trackPageView() {
                const pageData = {
                    url: window.location.href,
                    title: document.title,
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent
                };
                
                // Store locally for demo (in production, send to analytics service)
                const pageViews = JSON.parse(localStorage.getItem('pageViews') || '[]');
                pageViews.push(pageData);
                localStorage.setItem('pageViews', JSON.stringify(pageViews));
                
                console.log('Page view tracked:', pageData);
            }

            trackClick(event) {
                const clickData = {
                    element: event.target.tagName,
                    text: event.target.textContent?.substring(0, 50),
                    timestamp: new Date().toISOString()
                };
                
                console.log('Click tracked:', clickData);
            }

            // Personalization
            enablePersonalization() {
                console.log('Personalization enabled');
                
                // Example: Remember user preferences
                this.loadUserPreferences();
                
                // Example: Customize content based on previous visits
                this.customizeContent();
            }

            loadUserPreferences() {
                const prefs = JSON.parse(localStorage.getItem('userPreferences') || '{}');
                if (prefs.theme) {
                    document.body.className = prefs.theme;
                }
                console.log('User preferences loaded:', prefs);
            }

            customizeContent() {
                const visitCount = parseInt(localStorage.getItem('visitCount') || '0') + 1;
                localStorage.setItem('visitCount', visitCount.toString());
                
                if (visitCount > 1) {
                    console.log(`Welcome back! This is your ${visitCount}th visit.`);
                    // Could show personalized content for returning users
                }
            }

            // Marketing tracking
            enableMarketing() {
                console.log('Marketing enabled - tracking for ad targeting');
                
                // Track user interests based on content viewed
                this.trackInterests();
                
                // In production, integrate with:
                // Facebook Pixel, Google Ads, etc.
            }

            trackInterests() {
                const interests = JSON.parse(localStorage.getItem('userInterests') || '[]');
                
                // Example: Track what sections user spends time on
                const currentPage = window.location.pathname;
                if (!interests.includes(currentPage)) {
                    interests.push(currentPage);
                    localStorage.setItem('userInterests', JSON.stringify(interests));
                }
                
                console.log('User interests updated:', interests);
            }

            // Check if banner should be shown
            shouldShowBanner() {
                return !this.getCookie('cookieConsentGiven');
            }
        }

        // Initialize cookie manager
        const cookieManager = new CookieManager();

        // UI Functions
        function showCookieModal() {
            document.getElementById('cookieModal').style.display = 'block';
            
            // Set toggle states based on current preferences
            updateToggleState('analyticsToggle', cookieManager.preferences.analytics);
            updateToggleState('personalizationToggle', cookieManager.preferences.personalization);
            updateToggleState('marketingToggle', cookieManager.preferences.marketing);
        }

        function closeCookieModal() {
            document.getElementById('cookieModal').style.display = 'none';
        }

        function toggleCookie(type) {
            cookieManager.preferences[type] = !cookieManager.preferences[type];
            updateToggleState(type + 'Toggle', cookieManager.preferences[type]);
        }

        function updateToggleState(toggleId, isActive) {
            const toggle = document.getElementById(toggleId);
            if (isActive) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }
        }

        function acceptAllCookies() {
            cookieManager.preferences = {
                essential: true,
                analytics: true,
                personalization: true,
                marketing: true
            };
            cookieManager.savePreferences();
            hideCookieBanner();
        }

        function rejectCookies() {
            cookieManager.preferences = {
                essential: true,
                analytics: false,
                personalization: false,
                marketing: false
            };
            cookieManager.savePreferences();
            hideCookieBanner();
        }

        function saveCookiePreferences() {
            cookieManager.savePreferences();
            closeCookieModal();
            hideCookieBanner();
        }

        function hideCookieBanner() {
            document.getElementById('cookieBanner').style.display = 'none';
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            if (!cookieManager.shouldShowBanner()) {
                hideCookieBanner();
            }
        });

        // Demo function to show tracked data (for testing purposes)
        function showTrackedData() {
            console.log('=== TRACKED DATA ===');
            console.log('Page Views:', JSON.parse(localStorage.getItem('pageViews') || '[]'));
            console.log('User Interests:', JSON.parse(localStorage.getItem('userInterests') || '[]'));
            console.log('Visit Count:', localStorage.getItem('visitCount'));
            console.log('Cookie Preferences:', cookieManager.preferences);
        }

        // Call this in console to see what data is being tracked
        window.showTrackedData = showTrackedData;
    </script>
</body>
</html>
